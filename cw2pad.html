<html><meta charset="utf-8">
<style>
body, html { padding: 0; margin: 0 }
textarea { width: 100%; height: 50%; padding: 0; margin: 0 }
</style>
<textarea autofocus id="input" onchange="convert()" onkeyup="convert()" onkeydown="convert()" style="background: #ddd">
</textarea>
<br>
<textarea id="output" readonly style="background: #000; color: white">
</textarea>
<script>
function convert(){
var x = document.getElementById('input').value;

  var out, i$, ref$, len$, ln, replace$ = ''.replace;
  out = '';
  var names = {};
  ref$ = x.split(/\n+/);
  out += (ref$.shift() + "\n");
  for (i$ = 0, len$ = ref$.length; i$ < len$; ++i$) {
    ln = ref$[i$];
    if (/^\s*$/.exec(ln)) {
      continue;
    }
    if (/[\(\[]crosstalk[\)\]]/.exec(ln)) {
      continue;
    }
    if (/[-'\w ]+:/.exec(ln) && /^((?:\s\w\.|[-'\w ]+)+):/.exec(ln)) {
      var n = RegExp.$1;
      if (/ /.test(n)) {
        names[n.replace(/ .*/, '')] = n;
      }
      else if (names[n]) {
        ln = replace$.call(ln, /^(?:\s\w\.|[-'\w ]+)+:/, (names[n] + ':'));
      }
    }

    if (/^\[(.*)\]/.exec(ln)) {
      out += "\n" + (replace$.call(ln, /^\[(.*)\]/, '($1)')) + "\n";
      continue;
    }
    if (/[-'\w ]+:/.exec(ln) && /^(?:\s\w\.|[-'\w ]+)+: +/.exec(ln)) {
      out += "\n" + (replace$.call(ln, /^((?:\s\w\.|[-'\w ]+)+): +/, "$1:\n    ")) + "\n";
      continue;
    }
    if (/\S/.exec(ln))  {
      out += "    " + ln + "\n";
      continue;
    }
  }

document.getElementById('output').value = out;
}
</script>
